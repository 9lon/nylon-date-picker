<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">

<dom-module id="nylon-date-picker">
  <template>
    <style>
       :host {
        display: block;
      }

      div {
        font-size: 10px
      }

      .calendar_modern {
        padding: 50px;
      }

      .calendar_modern .calendar {
        margin: auto;
        width: 240px;
        height: 290px;
      }

      .calendar_modern .calendar .nav {
        height: 0;
        position: relative;
      }

      .calendar_modern .calendar .nav i,
      .calendar_modern .calendar .nav b {
        display: block;
        font-style: normal;
        position: absolute;
        cursor: pointer;
        width: 30px;
        height: 30px;
        z-index: 100;
        top: 0;
      }

      .calendar_modern .calendar .nav i {
        left: 0;
        border-right: 1px solid #423a37;
        background: url(http://cs4399.userapi.com/u49225742/docs/58f03726ea27/lft.png) no-repeat center center transparent;
      }

      .calendar_modern .calendar .nav b {
        right: 0;
        border-left: 1px solid #423a37;
        background: url(http://cs4399.userapi.com/u49225742/docs/5fd2e9dd3a9f/rgt.png) no-repeat center center transparent;
      }

      .calendar_modern .calendar .month .header {
        height: 30px;
        position: relative;
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        line-height: 30px;
        font-weight: bold;
        font-size: 1.4em;
        text-align: center;
        background: #372f2c;
        border-radius: 3px;
      }

      .calendar_modern .calendar .month .body {
        background: #e4e4e4;
      }

      .calendar_modern .calendar .month .body .day_names {
        height: 25px;
      }

      .calendar_modern .calendar .month .body .day_names i {
        font-family: Arial, Helvetica, sans-serif;
        display: block;
        height: 25px;
        line-height: 25px;
        text-align: center;
        font-style: normal;
        float: left;
        width: 34px;
      }

      .calendar_modern .calendar .month .body .days s {
        font-family: Arial, Helvetica, sans-serif;
        display: block;
        float: left;
        width: 33px;
        height: 33px;

        font-size: 1.5em;
        font-weight: bold;
        line-height: 34px;
        text-align: center;
        font-style: normal;
        text-decoration: none;
        /* table like borders */
        border-right: 1px solid #aaaaaa;
        border-bottom: 1px solid #aaaaaa;
        /* table like borders */
        cursor: pointer;
      }


      .calendar_modern .calendar .month .body .days s:nth-child(n+1):nth-child(-n+7) {
        border-top: 1px solid #aaaaaa;
      }

      [i-left] {
        border-left: 1px solid #aaaaaa;
      }

      [i-select] {
        color: #3399ff;
        /* color:#fff; */
      }

      [i-frist],
      [i-last] {
        color: #8d8d8d;
      }

      [i-current] {
        color: #000;
      }

      span ,.n {
        cursor: pointer
      }
    </style>
    [[selected]]<br> [[selectedBe]]
    <div id="calendar" class="calendar_modern">
      <div class="calendar">



        <div class="months">
          <div class="month" data-date="2011.1">
            <div class="header"><span class="n" on-click="previousYear">&#60&#60</span>&nbsp;&nbsp;<span class="n" on-click="previousMonth">&#60</span>&nbsp;&nbsp;&nbsp;&nbsp;[[monthAndYear]]&nbsp;&nbsp;&nbsp;&nbsp;<span class="n" on-click="nextMonth">&#62</span>&nbsp;&nbsp;<span on-click="nextYear" class="n">&#62&#62</span></div>
            <div class="body">

              <div class="day_names">
                <template is="dom-repeat" items="[[daysOfWeek]]">
                  <i>[[item]]</i>
                </template>
              </div>
              <div class="days">
                <template is="dom-repeat" items="[[items]]">
                  <template is="dom-repeat" as="item2" items="[[item]]">
                    <s on-click="_selectDate" i-left$="[[_checkLeft(index)]]" i-select$="[[_checkType(item2.type,'select')]]" i-frist$="[[_checkType(item2.type,'frist')]]"
                      i-current$="[[_checkType(item2.type,'current')]]" i-last$="[[_checkType(item2.type,'last')]]">[[item2.day]]</s>
                  </template>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    /**
     * `nylon-date-picker`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class NylonDatePicker extends Polymer.Element {
      static get is() { return 'nylon-date-picker'; }
      static get properties() {
        return {
          selected: {
            type: String,
            observer: '_selectedChanged',
            notify: true,
            value:'2017-9-15'
            // 2017-1-15
          },
          selectedBe: {
            type: String,
            observer: '_selectedBeChanged',
            notify: true,
            //value:'15/9/2560'
          }
        };
      }

      constructor() {
        super()
        this.init()
        this.renderCalendar()
      }



      init() {
        this.daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
        this.months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        
        //xxx
        this.format = 'dd/mm/yyyy'

        var d = new Date()
        this.currentMonth = d.getMonth()
        this.currentYear = d.getFullYear()

        var f = this.format
        if (typeof (f) == 'string') {
          this.f = f.charAt(0).toUpperCase();
        } else {
          this.f = 'M';
        }
      }

      renderCalendar() {

        this.calendar(this.currentYear, this.currentMonth)
      }

      calendar(y, m) {
        var firstDayOfCurrentMonth = new Date(y, m, 1).getDay()
        var lastDateOfCurrentMonth = new Date(y, m + 1, 0).getDate()
        var lastDateOfLastMonth = m == 0 ? new Date(y - 1, 11, 0).getDate() : new Date(y, m, 0).getDate()
        var monthandyear = this.months[m] + ' - ' + (y + 543)

        var dm = this.f == 'M' ? 1 : firstDayOfCurrentMonth == 0 ? -5 : 2
        var p = dm

        var cellvalue;
        var dataCal = [];

        for (var d, i = 0, z0 = 0; z0 < 6; z0++) {
          var datarow = [];
          for (var z0a = 0; z0a < 7; z0a++) {
            d = i + dm - firstDayOfCurrentMonth;

            if (d < 1) {
              cellvalue = lastDateOfLastMonth - firstDayOfCurrentMonth + p++;

              var getM;
              var getY;
              if (m == 0) {
                getM = 11
                getY = y - 1
              } else {
                getM = m - 1
                getY = y
              }

              datarow.push({ type: 'frist', day: cellvalue, month: getM, year: getY, date: `${getY}-${getM + 1}-${cellvalue}` })
            } else if (d > lastDateOfCurrentMonth) {

              var getM;
              var getY;
              if (m == 11) {
                getM = 0
                getY = y + 1
              } else {
                getM = m + 1
                getY = y
              }
              datarow.push({ type: 'last', day: p, month: getM, year: getY, date: `${getY}-${getM + 1}-${p}` })

              p++
            } else {
              var type = 'current'
              if (this.selectData)
                if (this.selectData.day == d && this.selectData.month == m && this.selectData.year == y)
                  type = 'select'

              datarow.push({ type: type, day: d, month: m, year: y, date: `${y}-${m + 1}-${d}` })
              p = 1;
            }

            if (i % 7 == 6 && d >= lastDateOfCurrentMonth) {

              z0 = 10; // no more rows
            }

            i++;
          }
          dataCal.push(datarow);



        }

        this.monthAndYear = monthandyear
        this.items = dataCal
      }

      nextMonth() {
        if (this.currentMonth == 11) {

          this.currentMonth = 0;
          this.currentYear = this.currentYear + 1;

        } else {

          this.currentMonth = this.currentMonth + 1;

        }
        this.renderCalendar()
      }
      previousMonth() {
        if (this.currentMonth == 0) {

          this.currentMonth = 11;
          this.currentYear = this.currentYear - 1;

        } else {

          this.currentMonth = this.currentMonth - 1;

        }
        this.renderCalendar()
      }
      previousYear() {
        this.currentYear = this.currentYear - 1;
        this.renderCalendar()
      }
      nextYear() {
        this.currentYear = this.currentYear + 1;
        this.renderCalendar()
      }

      _checkType(type, select) {
        return type == select
      }
      _checkLeft(i) {
        return i == 0
      }

      _selectDate(e) {
        this.selected = e.model.item2.date
      }

      _selectedChanged(selected) {
        var select = selected.split('-')

        this.selectData = {
          day: parseInt(select[2]),
          month: parseInt(select[1]) - 1,
          year: parseInt(select[0])
        }

        this.selectedBe = `${this.selectData.day}/${this.selectData.month + 1}/${this.selectData.year + 543}`
        this.currentYear = this.selectData.year
        this.currentMonth = this.selectData.month
        this.renderCalendar()

      }

      _selectedBeChanged(selectedBe) {
        var select = selectedBe.split('/')

        var selectData = {
          day: parseInt(select[0]),
          month: parseInt(select[1]) - 1,
          year: parseInt(select[2] - 543)
        }
        this.selected = (`${selectData.year}-${selectData.month + 1}-${selectData.day}`)
      }
    }

    window.customElements.define(NylonDatePicker.is, NylonDatePicker);
  </script>
</dom-module>